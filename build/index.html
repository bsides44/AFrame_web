<html>

	<head>
		<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
		<script src="https://raw.githack.com/AR-js-org/AR.js/3.4.0/aframe/build/aframe-ar.js"></script>
		<!-- animation -->
		<script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
		<!-- NB: WebXR features like hit testing don't currently work on iOS -->
		<script>
		AFRAME.registerComponent("hide-on-hit-test-start", {
			init: function() {
				
				this.el.sceneEl.addEventListener("ar-hit-test-start", function(ev) {
					ev.target.object3D.visible = false;
				});
				this.el.sceneEl.addEventListener('ar-hit-test-select', (ev) => {
					ev.target.object3D.visible = true;
					ev.target.object3D.position = ev.detail.position;
				});
				this.el.sceneEl.addEventListener("exit-vr", function() {
					ev.target.object3D.visible = true;
				});
			}
		  });

		  AFRAME.registerComponent('ar-shadows', {
			// StSpanHo https://github.com/stspanho/aframe-hit-test
			// Swap ground plane's material to a transparent shadows-only material in AR mode. 
			schema: {
				opacity: {default: 0.3}
			},
			init: function () {
				this.el.sceneEl.addEventListener('enter-vr', (ev) => {
					this.wasVisible = this.el.getAttribute('visible');
					if (this.el.sceneEl.is('ar-mode')) {
						this.savedMaterial = this.el.object3D.children[0].material;
						this.el.object3D.children[0].material = new THREE.ShadowMaterial();
						this.el.object3D.children[0].material.opacity = this.data.opacity;
						this.el.setAttribute('visible', true);
					}
				});
				this.el.sceneEl.addEventListener('exit-vr', (ev) => {
					if (this.savedMaterial) {
						this.el.object3D.children[0].material = this.savedMaterial;
						this.savedMaterial = null;
					}
					if (!this.wasVisible) this.el.setAttribute('visible', false);
				});
			}
		});

		  </script>
		  <style>
			.a-enter-ar{
				position: fixed !important;
				right: 80px !important;
			}
		  </style>
	</head>

	<body>
			<a-scene embedded arjs
				webxr="overlayElement:#dom-overlay; optionalFeatures:hit-test;" 
				ar-hit-test="target:#me-gltf;"
				reflection="directionalLight:#dirlight;"
				shadow="type: pcfsoft"
				raycaster="objects: #me-gltf"
				> 
			<a-assets>
				<a-asset-item id="me-gltf" src="./me_dance.gltf" response-type="arraybuffer"></a-asset-item>
			</a-assets>

			<a-entity hide-on-hit-test-start
				gltf-model="#me-gltf"	
				animation-mixer="loop:repeat"
				position="-1 0 -3" 
				rotation="0 55 0"
				shadow="cast: true; receive: false"></a-entity>

			<!-- AR shadow receiving plane  -->
			<a-plane height="30" width="30" rotation="-90 0 0"
				shadow="receive: true"
				ar-shadows="opacity: 0.2"
				visible="false"></a-plane>
	
			<a-entity light="type: hemisphere; intensity: 10"></a-entity>
			<a-light type="directional"
				light="intensity: 10;
					castShadow: true;
					shadowMapHeight: 1024;
					shadowMapWidth: 1024;
					shadowCameraLeft: -7;
					shadowCameraRight: 5;
					shadowCameraBottom: -5;
					shadowCameraTop: 5;"
				id="dirlight"
				target="me-gltf"
				position="-2 4 2">
   			</a-light>
			<a-camera position="0 1.2 0"></a-camera>
		</a-scene>
	</body>

</html>